!?]+/).filter(sentence => sentence.trim().length > 0);
            
            // Calculate sentences per day (equal distribution)
            const sentencesPerDay = Math.ceil(sentences.length / totalDays);
            
            // Create segments for each day
            for (let day = 0; day < totalDays; day++) {
                const segmentDate = new Date(today);
                segmentDate.setDate(today.getDate() + day);
                
                // Get sentences for this day
                const startIndex = day * sentencesPerDay;
                const endIndex = Math.min(startIndex + sentencesPerDay, sentences.length);
                const daySentences = sentences.slice(startIndex, endIndex);
                
                // Skip if no sentences for this day
                if (daySentences.length === 0) continue;
                
                // Reconstruct content for this day
                const dayContent = daySentences.join('. ').trim() + '.';
                
                segments.push({
                    id: Date.now() + day,
                    materialId: material.id,
                    materialTitle: material.title,
                    materialType: material.type,
                    title: `${material.title} - Day ${day + 1}`,
                    content: dayContent,
                    date: segmentDate.toISOString().split('T')[0],
                    time: ['09:00', '14:00', '16:00', '19:00'][day % 4],
                    completed: false,
                    day: day + 1,
                    duration: 30 + (day * 5), // Gradually increase duration
                    objectives: [
                        `Study ${daySentences.length} key concepts from ${material.title}`,
                        `Review and understand the content thoroughly`,
                        `Take notes on important points`,
                        `Practice recall and comprehension`
                    ],
                    sentenceCount: daySentences.length,
                    totalSentences: sentences.length
                });
            }
            
            return segments;
        }

        // Add new material
        function addMaterial() {
            editingMaterialId = null;
            modalTitle.textContent = 'Add New Material';
            materialForm.reset();
            
            // Set default deadline to 1 week from now
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 7);
            document.getElementById('materialDeadline').value = defaultDeadline.toISOString().split('T')[0];
            
            materialModal.style.display = 'block';
        }

        // Handle form submission
        materialForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('materialTitle').value,
                type: document.getElementById('materialType').value,
                content: document.getElementById('materialContent').value,
                deadline: document.getElementById('materialDeadline').value
            };

            if (editingMaterialId) {
                // Update existing material
                const materialIndex = materials.findIndex(m => m.id === editingMaterialId);
                if (materialIndex !== -1) {
                    materials[materialIndex] = {
                        ...materials[materialIndex],
                        ...formData
                    };
                    showNotification('Material updated successfully!', 'success');
                }
            } else {
                // Add new material
                const newMaterial = {
                    id: Date.now(),
                    ...formData,
                    progress: 0,
                    filename: 'Manual Entry'
                };
                materials.push(newMaterial);
                showNotification('Material added successfully!', 'success');
            }

            saveMaterials();
            renderMaterials();
            materialModal.style.display = 'none';
        });

        // Handle file upload - MODIFIED TO SHOW POPUP
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            // Process first file (for simplicity, handle one at a time)
            const file = files[0];
            
            // Store file data temporarily
            pendingFileData = {
                file: file,
                filename: file.name
            };
            
            // Pre-fill the form with file name (without extension)
            document.getElementById('fileTitle').value = file.name.replace(/\.[^/.]+$/, "");
            
            // Set default deadline to 1 week from now
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 7);
            document.getElementById('fileDeadline').value = defaultDeadline.toISOString().split('T')[0];
            
            // Show the file upload configuration modal
            fileUploadModal.style.display = 'block';
        }

        // Handle file upload form submission
        fileUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!pendingFileData) return;
            
            const file = pendingFileData.file;
            const formData = {
                title: document.getElementById('fileTitle').value,
                type: document.getElementById('fileType').value,
                deadline: document.getElementById('fileDeadline').value
            };
            
            // Process file content based on type
            if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                // Handle text files
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    addFileAsMaterial(file, content, formData);
                };
                reader.readAsText(file);
            } else if (file.type.startsWith('image/')) {
                // Handle image files
                addFileAsMaterial(file, 'Image file uploaded - content will be extracted when processed', formData);
            } else {
                // Handle other file types (PDF, DOCX, etc.)
                addFileAsMaterial(file, 'File uploaded successfully - content will be extracted when processed', formData);
            }
            
            // Close modal and reset
            fileUploadModal.style.display = 'none';
            pendingFileData = null;
            fileUploadForm.reset();
        });

        // Helper function to add file as material with user configuration
        function addFileAsMaterial(file, content, formData) {
            const newMaterial = {
                id: Date.now() + Math.random(),
                title: formData.title,
                type: formData.type,
                content: content,
                filename: file.name,
                progress: 0,
                deadline: formData.deadline
            };
            
            materials.push(newMaterial);
            saveMaterials();
            renderMaterials();
            showNotification(`${file.name} uploaded and configured successfully!`, 'success');
        }

        // File upload handling
        fileInput.addEventListener('change', handleFileUpload);
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileUpload({ target: { files: e.dataTransfer.files } });
        });

        // Modal controls for material modal
        closeModal.addEventListener('click', () => {
            materialModal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            materialModal.style.display = 'none';
        });

        // Modal controls for file upload modal
        closeFileModal.addEventListener('click', () => {
            fileUploadModal.style.display = 'none';
            pendingFileData = null;
        });

        cancelFileBtn.addEventListener('click', () => {
            fileUploadModal.style.display = 'none';
            pendingFileData = null;
        });

        // Close modals when clicking outside
        materialModal.addEventListener('click', (e) => {
            if (e.target === materialModal) {
                materialModal.style.display = 'none';
            }
        });

        fileUploadModal.addEventListener('click', (e) => {
            if (e.target === fileUploadModal) {
                fileUploadModal.style.display = 'none';
                pendingFileData = null;
            }
        });

        // Add material button (you can add this to your UI)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'n' && e.ctrlKey) {
                e.preventDefault();
                addMaterial();
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadMaterials();
        });

        // Make functions globally available
        window.deleteMaterial = deleteMaterial;
        window.editMaterial = editMaterial;
        window.startLearning = startLearning;
        window.scheduleStudy = scheduleStudy;
        window.addMaterial = addMaterial;
    </script>
</body>
            </html>